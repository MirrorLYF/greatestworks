# 架构文档

## 📖 概述

GreatestWorks 采用现代化的软件架构设计，结合领域驱动设计 (DDD)、微服务架构、事件驱动架构等最佳实践，构建了一个高性能、可扩展、易维护的 MMO 游戏服务器系统。

## 🏗️ 架构概览

### 核心架构原则

1. **领域驱动设计 (DDD)**: 以业务领域为核心的设计方法
2. **微服务架构**: 服务解耦，独立部署和扩展
3. **事件驱动**: 异步消息传递，提高系统响应性
4. **CQRS**: 命令查询职责分离，优化读写性能
5. **六边形架构**: 端口适配器模式，提高可测试性

### 系统分层

```
┌─────────────────────────────────────────┐
│              接口层 (Interfaces)          │
│  HTTP API │ TCP Handler │ WebSocket     │
├─────────────────────────────────────────┤
│             应用层 (Application)          │
│  Services │ Commands │ Queries │ DTOs   │
├─────────────────────────────────────────┤
│              领域层 (Domain)             │
│  Entities │ Aggregates │ Services │ Events │
├─────────────────────────────────────────┤
│            基础设施层 (Infrastructure)     │
│  Database │ Cache │ Message Queue │ Config │
└─────────────────────────────────────────┘
```

## 📚 架构文档目录

### [🎯 DDD 设计](./ddd-design.md)
详细介绍领域驱动设计在项目中的应用，包括：
- 领域模型设计
- 聚合根定义
- 领域服务实现
- 领域事件处理

### [🔧 微服务架构](./microservices.md)
微服务架构的设计和实现，包括：
- 服务拆分策略
- 服务间通信
- 服务发现机制
- 负载均衡

### [🗄️ 数据库设计](./database-design.md)
数据存储架构设计，包括：
- 数据模型设计
- 分库分表策略
- 缓存架构
- 数据一致性

### [⚡ 事件驱动架构](./event-driven.md)
事件驱动系统的设计，包括：
- 事件总线设计
- 事件存储
- 事件溯源
- 最终一致性

## 🎮 业务领域

### 核心领域

1. **玩家管理 (Player)**
   - 玩家账户
   - 角色信息
   - 等级经验
   - 新手引导

2. **游戏世界 (Scene)**
   - 场景管理
   - 地图系统
   - 传送机制

3. **战斗系统 (Battle)**
   - PVP 战斗
   - PVE 战斗
   - 技能系统
   - 伤害计算

### 支撑领域

1. **物品系统 (Inventory)**
   - 背包管理
   - 装备系统
   - 道具合成
   - 换装系统

2. **社交系统 (Social)**
   - 好友系统
   - 聊天系统
   - 邮件系统
   - 家族/公会

3. **任务系统 (Quest)**
   - 主线任务
   - 支线任务
   - 日常任务
   - 成就系统

### 通用领域

1. **排行榜 (Ranking)**
   - 等级排行
   - 财富排行
   - PVP 排行

2. **宠物系统 (Pet)**
   - 宠物养成
   - 宠物战斗
   - 宠物繁殖

3. **建筑系统 (Building)**
   - 基地建设
   - 资源生产
   - 建筑升级

## 🔄 数据流架构

### 请求处理流程

```
客户端请求 → 接口层 → 应用服务 → 领域服务 → 基础设施 → 数据库
     ↓
响应返回 ← 接口层 ← 应用服务 ← 领域服务 ← 基础设施 ← 数据库
```

### 事件处理流程

```
领域事件 → 事件总线 → 事件处理器 → 应用服务 → 外部系统
```

## 🚀 技术栈

### 后端技术

- **语言**: Go 1.21+
- **框架**: 自研游戏框架 + Gin (HTTP)
- **数据库**: MongoDB (主数据库) + Redis (缓存)
- **消息队列**: NATS
- **协议**: TCP + WebSocket + HTTP
- **序列化**: Protocol Buffers

### 基础设施

- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (生产环境)
- **监控**: Prometheus + Grafana
- **日志**: 结构化日志 + ELK Stack
- **配置**: YAML + 环境变量

### 开发工具

- **版本控制**: Git + GitHub
- **CI/CD**: GitHub Actions
- **代码质量**: golangci-lint + SonarQube
- **文档**: Markdown + 自动生成

## 📈 性能指标

### 系统性能

- **并发用户**: 10,000+ CCU
- **响应时间**: < 100ms (P95)
- **吞吐量**: 100,000+ TPS
- **可用性**: 99.9%+

### 扩展性

- **水平扩展**: 支持多实例部署
- **垂直扩展**: 支持资源动态调整
- **跨区域**: 支持多区域部署

## 🔒 安全架构

### 认证授权

- **JWT Token**: 无状态认证
- **RBAC**: 基于角色的访问控制
- **API 网关**: 统一认证入口

### 数据安全

- **数据加密**: 敏感数据加密存储
- **传输加密**: TLS/SSL 加密传输
- **访问控制**: 数据库访问权限控制

### 系统安全

- **防火墙**: 网络访问控制
- **DDoS 防护**: 流量清洗和限流
- **安全审计**: 操作日志和审计

## 🎯 设计模式

### 领域层模式

- **聚合模式**: 数据一致性边界
- **工厂模式**: 复杂对象创建
- **策略模式**: 算法封装
- **观察者模式**: 事件通知

### 应用层模式

- **命令模式**: 操作封装
- **查询对象**: 查询封装
- **DTO 模式**: 数据传输
- **适配器模式**: 接口适配

### 基础设施模式

- **仓储模式**: 数据访问抽象
- **单例模式**: 资源管理
- **连接池**: 资源复用
- **缓存模式**: 性能优化

## 📋 架构决策记录 (ADR)

### ADR-001: 选择 Go 语言
- **状态**: 已接受
- **决策**: 使用 Go 作为主要开发语言
- **理由**: 高性能、并发支持、简单易维护

### ADR-002: 采用 DDD 架构
- **状态**: 已接受
- **决策**: 使用领域驱动设计
- **理由**: 复杂业务逻辑、团队协作、长期维护

### ADR-003: 选择 MongoDB
- **状态**: 已接受
- **决策**: 使用 MongoDB 作为主数据库
- **理由**: 文档存储、水平扩展、开发效率

## 🔄 演进路线

### 第一阶段 (当前)
- ✅ DDD 架构重构
- ✅ 核心游戏功能
- ✅ 基础监控体系

### 第二阶段 (规划中)
- 🔄 微服务拆分
- 🔄 事件溯源实现
- 🔄 CQRS 优化

### 第三阶段 (未来)
- ⏳ 多区域部署
- ⏳ 实时数据分析
- ⏳ AI 智能运营

---

*架构版本: v1.0.0 | 最后更新: 2024年*